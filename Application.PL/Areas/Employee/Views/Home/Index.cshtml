@model EmployeeDashboardVM
@{
    ViewData["Title"] = "My Dashboard";
}

<div class="container-fluid py-4">
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6>Total Salaries</h6>
                <h3>@Model.TotalSalaries.ToString("C")</h3>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6>Total Overtime</h6>
                <h3>@Model.TotalOvertimes.ToString("C")</h3>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6>Total Deductions</h6>
                <h3>@Model.TotalDeductions.ToString("C")</h3>
            </div></div>
        </div>
        <div class="col-md-3">
            <div class="card"><div class="card-body">
                <h6>Net (Estimated)</h6>
                <h3>@((Model.TotalSalaries + Model.TotalOvertimes - Model.TotalDeductions).ToString("C"))</h3>
            </div></div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card"><div class="card-body">
                <h5>Attendance Calendar</h5>
                <div id="employeeCalendar"></div>
                <p class="small text-muted mt-3">Click a day to view details</p>
            </div></div>

            <div class="card mt-3"><div class="card-body">
                <h6>Recent Overtime</h6>
                <ul class="list-unstyled">
                    @foreach(var o in Model.RecentOvertimes)
                    {
                        <li class="py-2 border-bottom d-flex justify-content-between">
                            <div>@o.Date.ToString("yyyy-MM-dd") - @o.Hours hrs</div>
                            <div>@o.Total.ToString("C")</div>
                        </li>
                    }
                </ul>
            </div></div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-3"><div class="card-body">
                <h6>Company</h6>
                <p><strong>@Model.CompanyName</strong><br />@Model.CompanyAddress</p>
            </div></div>

            <div class="card mb-3"><div class="card-body">
                <h6>Recent Payroll</h6>
                <ul class="list-unstyled mb-0">
                    @foreach(var s in Model.RecentSalaries)
                    {
                        <li class="py-2 d-flex justify-content-between border-bottom">
                            <div>
                                <strong>@s.PayDate.ToString("yyyy-MM-dd")</strong>
                                <div class="small text-muted">Net: @s.Amount.ToString("C")</div>
                            </div>
                            <div>
                                @if (s.Id > 0)
                                {
                                    <a asp-action="DownloadPayslip" asp-route-id="@s.Id" class="btn btn-sm btn-outline-primary">Download</a>
                                }
                                else
                                {
                                    <span class="text-muted small">No payslip</span>
                                }
                            </div>
                        </li>
                    }
                </ul>
            </div></div>

            <div class="card"><div class="card-body">
                <h6>Recent Deductions</h6>
                <ul class="list-unstyled mb-0">
                    @foreach(var d in Model.RecentDeductions)
                    {
                        <li class="py-2 d-flex justify-content-between border-bottom">
                            <div>
                                <strong>@d.CreatedAt.ToString("yyyy-MM-dd")</strong>
                                <div class="small text-muted">@d.Reason</div>
                            </div>
                            <div>@d.Amount.ToString("C")</div>
                        </li>
                    }
                </ul>
            </div></div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<!-- Event details modal (Bootstrap) -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalTitle">Event</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="eventModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('employeeCalendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 600,
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek' },
            events: function (info, successCallback, failureCallback) {
                fetch('@Url.Action("AttendanceEvents", "Home", new { area = "Employee" })')
                    .then(r => r.json())
                    .then(data => successCallback(data))
                    .catch(err => failureCallback(err));
            },
            eventDidMount: function (info) {
                // attach Bootstrap tooltip with useful info
                try {
                    var title = info.event.title || '';
                    var start = info.event.start ? new Date(info.event.start).toLocaleString() : '';
                    var end = info.event.end ? new Date(info.event.end).toLocaleString() : '';
                    var ext = info.event.extendedProps || {};
                    var details = title + '\n' + start + (end ? ' - ' + end : '');
                    if (ext && ext.deductionReasons) details += '\nDeductions: ' + ext.deductionReasons;
                    if (ext && ext.overtimeHours) details += '\nOvertime: ' + ext.overtimeHours + ' hrs';

                    // clean up any previous tooltip instance
                    if (info.el._tooltip) {
                        info.el._tooltip.dispose();
                    }

                    var bsTooltip = new bootstrap.Tooltip(info.el, {
                        title: details,
                        placement: 'top',
                        trigger: 'hover focus'
                    });
                    // keep reference to dispose later
                    info.el._tooltip = bsTooltip;

                    // accent left border based on color property
                    var color = info.event.backgroundColor || (info.event.extendedProps && info.event.extendedProps.color) || null;
                    if (color) {
                        info.el.style.borderLeft = '4px solid ' + color;
                        info.el.style.paddingLeft = '8px';
                    }
                } catch (e) {
                    console.warn('eventDidMount error', e);
                }
            },
            eventClick: function (info) {
                info.jsEvent.preventDefault();
                var ev = info.event;
                var ext = ev.extendedProps || {};
                var start = ev.start ? new Date(ev.start).toLocaleString() : '';
                var end = ev.end ? new Date(ev.end).toLocaleString() : '';
                var html = '';
                html += '<p><strong>' + (ev.title || 'Event') + '</strong></p>';
                if (start) html += '<p><strong>Start:</strong> ' + start + '</p>';
                if (end) html += '<p><strong>End:</strong> ' + end + '</p>';
                if (ext.overtimeHours) html += '<p><strong>Overtime:</strong> ' + ext.overtimeHours + ' hrs</p>';
                if (ext.minutesDeducted) html += '<p><strong>Deductions minutes:</strong> ' + ext.minutesDeducted + '</p>';
                if (ext.deductionReasons) html += '<p><strong>Deduction reasons:</strong> ' + ext.deductionReasons + '</p>';
                if (ev.id && ev.id.toString().startsWith('ot_')) {
                    html += '<p><span class="badge bg-primary">Overtime</span></p>';
                } else if (ev.allDay) {
                    html += '<p><span class="badge bg-danger">Absent</span></p>';
                }

                document.getElementById('eventModalTitle').textContent = ev.title || 'Details';
                document.getElementById('eventModalBody').innerHTML = html;
                var modal = new bootstrap.Modal(document.getElementById('eventModal'));
                modal.show();
            }
        });
        calendar.render();
    });
</script>